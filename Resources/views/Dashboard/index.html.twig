<!DOCTYPE html>
<html>
<head>

    <!-- CSS -->
    <link rel="stylesheet" href="{{ asset('bundles/livevoting/css/bootstrap.css') }}">
    <link rel="stylesheet" href="{{ asset('bundles/livevoting/css/style.css') }}">
    <link rel="stylesheet" href= "{{ asset('bundles/livevoting/css/normalize.css') }}"  />

    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="http://code.highcharts.com/highcharts.js"></script>
    <style type="text/css">
  @keyframes fadeIn{
    0% {background-color: white;opacity: 0;}
    50% {background-color: green;opacity: 0.5;}
    100% {background-color: white;opacity: 1;}
  }

  @-webkit-keyframes fadeIn{
    0% {background-color: white;opacity: 0;}
    50% {background-color: green;opacity: 0.5;}
    100% {background-color: white;opacity: 1;}
  }

  @keyframes fadeOut{
    0% {background-color: white;opacity: 1;}
    50% {background-color: red;opacity: 0.5;}
    100% {background-color: white;opacity: 0;}
  }

  @-webkit-keyframes fadeOut{
    0% {background-color: white;opacity: 1;}
    50% {background-color: red;opacity: 0.5;}
    100% {background-color: white;opacity: 0;}
  }
  .my-repeat-animation{
    margin: 10px;
    background-color: white;
  }
  .my-repeat-animation.ng-enter.ng-enter-active,
  .my-repeat-animation.ng-leave {
      -webkit-animation: fadeIn 3s linear;
      -moz-animation:    fadeIn 3s linear;
      -o-animation:      fadeIn 3s linear;
      animation:         fadeIn 3s linear;
  }

  /* Remove animation */
  .my-repeat-animation.ng-leave.ng-leave-active,
  .my-repeat-animation.ng-enter {
      -webkit-animation: fadeOut 3s linear;
      -moz-animation:    fadeOut 3s linear;
      -o-animation:      fadeOut 3s linear;
      animation:         fadeOut 3s linear;
  }
</style>
</head>
<body>

<div class="navbar navbar-default navbar-collapse">
    <div class="container">
        <div class="navbar-header">
            <ul class="list-inline list-unstyled text-center">
                <li>
                    <a href="{{ path('root') }}">
                      <img width="25" height="25" src="{{ asset('bundles/livevoting/img/kruzici.svg') }}" class="img-responsive" alt="logo">
                    </a>
                </li>
                <li>
                    <h3>Netgen Event Voting</h3>
                </li>
            </ul>
        </div>
    </div>
</div>

<div id="container" style="width:100%; height:400px;">
</div>

<div class="container" ng-app="myApp" ng-controller="MyCtrl">
  <div class="row my-repeat-animation" ng-repeat="div in divs">
    {{ '<div>
          <p>{{div.presenterName}} {{div.presenterSurname}}</p>
          <p>{{div.presentationName}}</p>
        </div>' }}
  </div>
</div>

<div class="container event-links">
    <a class="btn btn-default" href="{{ path('root') }}"><span class="glyphicon glyphicon-home"></span> Home</a>
</div>

<div id="footer-index">
    <div id="footer" class="container">
        <ul class="list-inline list-unstyled">
            <li class="hidden-xs">
                <img width="20" height="20" alt="Netgen" src="{{ asset('bundles/livevoting/img/kruzici.svg')}}" >
            </li>
            <li>
                <a href="http://www.netgenlabs.com">Netgenlabs.com</a>
            </li>
            <li class="hidden-xs" style="margin-left:3rem;">
                <img width="20" height="20" alt="GitHub Mark" src="{{ asset('bundles/livevoting/img/GitHub-Mark.png')}}">
            </li>
            <li>
                <a href="https://github.com/netgen/LiveVoting">GitHub project</a>
            </li>
        </ul>
    </div>
</div>

<script type="text/javascript">
    var requestData, animation_data, chart;
    function cmp(v1, v2){
        if(v1.presentationValue<v2.presentationValue)return 1;
        if(v1.presentationValue>v2.presentationValue)return -1;
        return 0;
    }
    function load(firstLoad){
        $.getJSON('{{ path("dashboard_presentations") }}', function(data){
            if('presentations' in data){
                var sortMe = [], presentationNames = [], presentationValues = [];//, counter = 0;
                for(var i in data['presentations']){
                    var pres = {};
                    pres.presentationName = data['presentations'][i]['presentationName'];

                    // Check if page is not loaded. If yes set all values to zero so that chart animates
                    if(firstLoad === true){
                      pres.presentationValue = 0;
                    }else{
                      pres.presentationValue = data['presentations'][i]['average'];
                    }
                    sortMe.push(pres);
                }
                sortMe.sort(cmp);
                for(var i in sortMe){
                    //if( counter < 3 ){
                        presentationNames.push(sortMe[i].presentationName);
                        presentationValues.push(sortMe[i].presentationValue);
                        //counter++;
                    //}
                }
                chart.xAxis[0].update({categories: presentationNames}, true);
                chart.series[0].setData(presentationValues, true, true, true);
            }
            //Check if loaded page. If yes animate chart in 500 miliseconds
            if(firstLoad === true){
              setTimeout(load, 500);
            }else{
              setTimeout(load, 5000);
            }
        });
    }


    $(document).ready(function(){

        chart = new Highcharts.Chart({
            chart: {
                renderTo: 'container',
                defaultSeriesType: 'bar',
                events: {
                    load: function(){
                        setTimeout(function(){load(true)}, 1000);
                    }
                }
            },
            plotOptions: {
                column:{
                    colorByPoint: true
                }
            },
            //colors: ['#2f7ed8', '#0d233a', '#8bbc21', '#910000', '#1aadce',
            //    '#492970', '#f28f43', '#77a1e5', '#c42525', '#a6c96a'],
            title: {
                text: 'Live results: Presentations'
            },
            xAxis: {
                type: 'String',
                tickPixelInterval: 5,
                title: {
                    text: 'Presentations name'
                }
            },
            yAxis: {
                minPadding: 0.1,
                maxPadding: 0.1,
                tickmarkPlacement: 'on',
                min: 0,
                max: 5,
                title: {
                    text: 'Average number of rating score'
                }
            },
            series: [
                {
                    showInLegend: false,
                    data:[],
                    dataLabels: {
                        enabled: true,
                        rotation: 0,
                        formatter: function() {
                            return this.y;
                        },
                        style: {
                            fontSize: '13px'
                        }
                    },
                    name: 'Average'
                }]
        });

    });
</script>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.14/angular.min.js"></script>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.14/angular-animate.min.js"></script>

<script type="text/javascript">
  var myApp = angular.module('myApp', ['ngAnimate']);
  myApp.controller('MyCtrl', function($scope, $http, $interval){
    $scope.divs;
      var ajaxFunction = function(){
        $http.get('/dashboard/liveschedule').success(function(data){
          if($scope.divs){
            if('presentations' in data){
            var givenData = [];
            var removeDivs = [];
            var givenData = [];
            var checkDivs = [];
              for(var i in data['presentations']){
                givenData.push(data['presentations'][i]);
              }

              var removeDivs = $scope.divs.slice(0);

              //Checking if any element is removed. Removed elements
              //will be in removeDivs at the end
              for(var i=0;i<givenData.length;i++){
                for(var j=0;j<removeDivs.length;j++){
                  if(removeDivs[j].id === givenData[i].id){
                    removeDivs.splice(j, 1);
                    j--;
                  }
                }
              }

              // If Something in removeDivs remove from DOM
              if(removeDivs.length !== 0){
                var indexNumbers = [];
                for(var i=0;i<removeDivs.length;i++){
                  indexNumbers.push(removeDivs[i].id);
                }

                for(var i=0;i<$scope.divs.length;i++){
                    for(var j=0;j<indexNumbers.length;j++){
                      if(indexNumbers[j] === $scope.divs[i].id){
                        indexNumbers.splice(j,1);
                        $scope.divs.splice(i,1);
                        i--;
                        j=0;
                      }
                    }
                }
              }

              var checkDivs = $scope.divs.slice(0);

              //Checking if any elemnent is added. Added elements
              //will be in givenData at the end
              for(var i=0;i<checkDivs.length;i++){
                for(var j=0;j<givenData.length;j++){
                  if(givenData[j].id === checkDivs[i].id){
                    givenData.splice(j, 1);
                    j--;
                  }
                }
              }

              // If Something in givenData add to DOM
              if(givenData.length !== 0){
                for(var i=0;i<givenData.length;i++){
                    $scope.divs.push(givenData[i]);
                }
              }

            }
          }else{
            if('presentations' in data){
              $scope.divs = [];
              for(var i in data['presentations']){
                $scope.divs.push(data['presentations'][i]);
              }
            }
          }
        });
      }

      angular.element(document).ready(function () {
        ajaxFunction();
        $interval(ajaxFunction, 5000);
      });

  });
</script>
</body>
</html>
