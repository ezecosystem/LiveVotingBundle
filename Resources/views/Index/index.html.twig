{% extends 'LiveVotingBundle::base.html.twig' %}

{% block stylesheets %}
	<link rel="stylesheet" href= "{{ asset('bundles/livevoting/css/normalize.css') }}"  />
{% endblock %}

{% block body %}
{% for flashMessage in app.Session.flashbag.get('message') %}
	<h3>{{flashMessage}}</h3>
{% endfor %}
	<div class="row">
		<div class="col-xs-12">
			<h1>Event: {{ event.getName }}</h1>
		</div>
	</div>

	<div id="voteScreen">
	</div>

	<div class="row spin-loader" id="loader">
		<div class="col-xs-12">
			<span>
				<i class="fa fa-cog fa-spin"></i>
			</span>
		</div>
	</div>

	<div class="row secondary-footer">
		<div class="col-xs-12">
			<a href="{{ path('user_landing') }}"><button type="button" class="btn"><i class="fa fa-chevron-left"></i>Back to events</button></a>
			{% if event.getAllowViewingResults %}
			<a href="{{ path('result', {'event_id':event.getId}) }}"><button type="button" class="btn"><i class="fa fa-bar-chart"></i>Live results</button></a>
			{% endif %}
		</div>
	</div>
{% endblock %}

{% block javascripts %}
	<script type="text/javascript" src="{{ asset('bundles/livevoting/js/handlebars-v1.3.0.js') }}"></script>
    <script type="text/javascript" src="{{ asset('bundles/livevoting/js/handlebars-intl.min.js') }}" ></script>
	<script type="text/javascript" src="{{ asset('bundles/livevoting/js/script.js') }}"></script>
	<script src="https://code.jquery.com/ui/1.11.0/jquery-ui.js"></script>

	<script type="text/javascript">
		$(document).ready(function(){
			new brain({
					'STATES':{
							'PRE':{'TIMEOUT':1},
							'ACTIVE':{'TIMEOUT':5},
							'POST':{'TIMEOUT':5}
			},
					'URLS':{
							'EVENT_STATUS':'/user/event_status/',
							'VOTE':'/user/vote/'
					}
			});
            HandlebarsIntl.registerWith(Handlebars);
		});
	</script>
	<script id="presentation" type="text/x-handlebars-template">
		<div class="pres voting-list-single row media">
			<div class="col-xs-12">
				<table class="pres-outer">
					<tr>
						<td class="pres-fixed">

							<img class="pres-img" src="{{ asset('bundles/livevoting/img/') }}{% verbatim %}{{#if image}}presentations/{{image}}{{else}}assets/presenter.svg{{/if}}{% endverbatim %}">
						</td>
						<td>
							<table>
								<tr>
									<td class="pres-head">
										<h2>{{ '{{presentationName}}' }}</h2>
									</td>
								</tr>
								<tr>
									<td class="pres-info">
										<span>{{ '{{presenterName}}' }} {{ '{{presenterSurname}}' }}</span>
										<span>
                                            {{ '{{ presentationLocation }}' }}
                                            <i class="fa fa-at"></i>
                                            {{ '{{ presentationBeginTime }}' }} - {{ '{{ presentationEndTime }}' }}</span>
										<span>
                                            <a class="pres-desc-toggle"
                                               data-expanded-text="Hide description"
                                               data-collapsed-text="Show description"
                                               data-toggle="collapse"
                                               href="#pres-desc-container-{{ '{{ presentationId }}' }}"
                                               aria-expanded="false" aria-controls="pres-desc-container">
                                                Show description
                                            </a>
                                        </span>
									</td>
								</tr>
							</table>
						</td>
					</tr>
				</table>
			</div>
			<div class="clearfix"></div>
			<div id="pres-desc-container-{{ '{{ presentationId }}' }}" class="col-xs-12 collapse">
				<div class="wrapper">
					<p class="pres-desc-text">{{ '{{ presentationDescription }}' }}</p>
				</div>
			</div>
			<div class="clearfix"></div>
			<div class="col-xs-12 col-sm-6">
				<form class="question-multiple" action="../user/vote/{{ '{{ questionId }}' }}" method="POST">
					<label>Rate presentation</label>
					<input class="q5" type="submit" value='5'/><!--
					--><input class="q4" type="submit" value='4'/><!--
					--><input class="q3" type="submit" value='3'/><!--
					--><input class="q2" type="submit" value='2'/><!--
					--><input class="q1" type="submit" value='1'/
				</form>
			</div>
			<div class="clearfix visible-xs-block"></div>
			<div class="col-xs-12 col-sm-6">
				<div class="pres-opinion">
					<h3 href="#">Share Your opinion!</h3>
					<a href="#">View comments (0)</a>
				</div>
			</div>

			<div class="col-xs-12">
                <div class="comments-section">
                    <ul class="nav nav-tabs" role="tablist">
                        <li role="presentation" class="active" >
                            <a class="tab-button live-comments-tab-toggle" data-toggle="tab" href="#liveVotingComments-{{ '{{ presentationId }}' }}" aria-controls="live-voting-comments" role="tab">LiveVoting Comments</a>
                        </li>
                        <li role="presentation" >
                            <a class="tab-button joindin-comments-tab-toggle" data-toggle="tab" href="#joindInComments-{{ '{{ presentationId }}' }}" aria-controls="joind-in-comments" role="tab" >Joind.in Comments</a>
                        </li>
                    </ul>
                    <div class="tab-content">
                        <div role="tabpanel" class="tab-pane fade in active" id="liveVotingComments-{{ '{{ presentationId }}' }}">
                            <ul  style="height: 300px;overflow-y: scroll" class="media-list live-voting-comments">
                                {% verbatim %}
                                    {{#each comments }}
                                        {{>comment }}
                                    {{/each }}
                                {% endverbatim %}
                            </ul>
                            <ul class="nav nav-tabs" role="tablist">
                                <li role="presentation" class="active" >
                                    <a href="#commentForm" aria-controls="comment" role="tab" data-toggle="tab">Comment</a>
                                </li>
                                <li role="presentation" >
                                    <a href="#pictureForm" aria-controls="picture" role="tab" data-toggle="tab">Picture</a>
                                </li>
                            </ul>
                            <div class="tab-content">
                                <div role="tabpanel" class="tab-pane fade in active" id="commentForm">
                                    {% set path = path('user_comment_presentation', {'presentationId': '{{presentationId}}'}) %}
                                    {{ form(
                                    form, {'action': path|replace({'%7B%7B': '{{', '%7D%7D': '}}'}), 'attr': {'class': 'commentPresentation'}}
                                    ) }}
                                </div>
                                <div role="tabpanel" class="tab-pane" id="pictureForm">
                                    {% set path2 = path('user_upload_image_presentation', {'presentationId': '{{presentationId}}'}) %}
                                    {{ form(
                                    imageForm, {'action': path2|replace({'%7B%7B': '{{', '%7D%7D': '}}'}), 'attr': {'class': 'imageUpload'}}
                                    ) }}
                                </div>
                            </div>
                        </div>
                        <div style="height: 300px;overflow-y: scroll" role="tabpanel" class="tab-pane fade joindin-comments-tab" id="joindInComments-{{ '{{ presentationId }}' }}">
                            <ul class="media-list live-voting-comments">
                                {% verbatim %}
                                    {{#each joindInComments }}
                                        {{>comment }}
                                    {{/each }}
                                {% endverbatim %}
                            </ul>
                        </div>
                    </div>
                </div>
			</div>

		</div>
	</script>

    <script id="comment-partial" type="text/x-handlebars-template">
        {% verbatim %}
            <li class="media">
                <a class="pull-left" href="#">
                    {{#if user_gravatar }}
                        <img src="{{ user_gravatar }}" class="img-responsive img-circle">
                    {{else}}
                        <i class="fa fa-user fa-5x"></i>
                    {{/if }}
                </a>
                <div class="media-body">
                    <div class="well well-lg">
                        <h4 class="media-heading text-uppercase reviews">{{ user_display_name }}</h4>
                        <ul class="media-date text-uppercase reviews list-inline">
                            <li>{{formatRelative published_at }}</li>
                        </ul>
                        <p class="media-comment">
                            {{{ content }}}
                        </p>
                    </div>
                </div>
            </li>
        {% endverbatim %}
    </script>

	<script type="text/javascript">
        var commentTemplate = Handlebars.compile($("#comment-partial").html());

        $('body').on('click', '.pres-desc-toggle', function (e) {
            if($(e.target).text() == $(e.target).data("expanded-text")) {
                $(e.target).text($(e.target).data("collapsed-text"));
            } else {
                $(e.target).text($(e.target).data("expanded-text"));
            }
        });


		$('body').on('submit', '.commentPresentation', function(e){
				e.preventDefault();
                $(e.target).closest("col-xs-12").find("a .live-comments-tab-toggle").trigger('click');
				var formData = new FormData(this);

				$.ajax({
						type:'POST',
						url: $(this).attr('action'),
						data:formData,
						processData: false,
						contentType: false,
						success:function(data){
                            $(e.target).closest(".col-xs-12")
                                    .find(".live-voting-comments")
                                    .append(commentTemplate(data));
						},
						error: function(data){
							alert('error');
						}
				});
				this.reset();
		});

			$('body').on('submit', '.imageUpload', function(e){
				e.preventDefault();
					var formData = new FormData(this);

					$.ajax({
							type:'POST',
							url: $(this).attr('action'),
							data:formData,
							processData: false,
							contentType: false,
							success:function(data){
									alert('Thank you for uploading image!');
							},
							error: function(data){
								alert('error');
							}
					});
					this.reset();
			});


	</script>
{% endblock %}
